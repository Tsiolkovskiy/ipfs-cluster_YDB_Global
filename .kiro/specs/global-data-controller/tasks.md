# Implementation Plan Global Data Controller

## Обзор

Данный план реализации разбивает создание Global Data Controller на инкрементальные этапы, каждый из которых строится на предыдущих и обеспечивает тестируемую функциональность. План следует принципам test-driven development и обеспечивает раннюю валидацию ключевых компонентов.

## Задачи реализации

- [x] 1. Настройка базовой инфраструктуры проекта
  - Создать структуру Go-модуля с основными пакетами
  - Настроить Docker Compose для локальной разработки с YDB, NATS, Prometheus
  - Создать базовые Makefile команды для сборки, тестирования и запуска
  - _Требования: NFR-5.1, NFR-4.1_

- [x] 2. Реализация основных моделей данных и интерфейсов
  - Определить Go структуры для Zone, Cluster, Node, Content, Policy, Replica
  - Создать интерфейсы для всех основных компонентов (PolicyEngine, Scheduler, Orchestrator)
  - Написать unit тесты для валидации моделей данных
  - _Требования: FR-1.1, FR-2.1, FR-5.1_

- [x] 3. Создание системы конфигурации и логирования
  - Реализовать загрузку конфигурации из файлов и переменных окружения
  - Настроить структурированное логирование с поддержкой trace_id
  - Добавить базовую телеметрию с OpenTelemetry
  - _Требования: NFR-4.1, NFR-4.3_

- [x] 4. Реализация MetadataStore с YDB интеграцией
  - Создать YDB схемы для zones, clusters, policies, shard_ownership
  - Реализовать CRUD операции для базовых сущностей
  - Написать интеграционные тесты с тестовой YDB
  - _Требования: FR-5.1, FR-3.1_

- [x] 5. Создание Event Bus с NATS JetStream
  - Настроить NATS JetStream с персистентными стримами
  - Реализовать publisher/subscriber паттерны для основных событий
  - Создать типизированные события (PinRequested, PlanReady, ExecProgress)
  - Написать тесты для событийных потоков
  - _Требования: FR-4.2, NFR-2.2_

- [x] 6. Реализация базового Policy Engine
  - Интегрировать OPA/Rego для оценки политик
  - Создать базовые политики для RF, EC, placement constraints
  - Реализовать CRUD операции для политик с версионированием
  - Написать тесты для различных сценариев политик
  - _Требования: FR-2.1, FR-2.2_

- [x] 7. Создание Topology Service
  - Реализовать регистрацию и управление зонами и кластерами
  - Добавить поддержку статусов (active, degraded, maintenance, offline)
  - Создать API для получения топологической информации
  - _Требования: FR-5.1, NFR-1.3_

- [x] 8. Реализация базового Scheduler
  - Создать алгоритм размещения с учётом RF и зональных ограничений
  - Реализовать простую cost-aware оптимизацию
  - Добавить валидацию планов размещения
  - Написать unit тесты для различных сценариев планирования
  - _Требования: FR-1.2, FR-6.1_

- [x] 9. Создание Cluster Control Adapter
  - Реализовать gRPC клиенты для взаимодействия с IPFS Cluster
  - Добавить идемпотентные операции pin/unpin с retry логикой
  - Создать мониторинг статуса операций в кластерах
  - Написать интеграционные тесты с mock IPFS Cluster
  - _Требования: FR-1.3, NFR-5.2_

- [x] 10. Реализация базового Orchestrator
  - Создать workflow engine для управления долгосрочными операциями
  - Реализовать saga pattern с checkpoint и compensation
  - Добавить retry логику с exponential backoff
  - Написать тесты для различных сценариев workflow
  - _Требования: FR-4.1, FR-4.3_

- [x] 11. Создание API Gateway
  - Реализовать HTTP/gRPC сервер с базовыми endpoints
  - Добавить валидацию запросов и rate limiting
  - Создать OpenAPI спецификацию
  - Написать API тесты для основных операций
  - _Требования: FR-8.2, NFR-5.2_

- [x] 12. Интеграция SPIFFE/SPIRE для аутентификации
  - Настроить SPIFFE/SPIRE для выдачи SVID
  - Реализовать mTLS аутентификацию между компонентами
  - Добавить middleware для проверки сертификатов
  - _Требования: NFR-3.1_

- [ ] 13. Реализация авторизации с OPA




  - Создать Rego политики для контроля доступа к API
  - Интегрировать OPA для проверки разрешений
  - Добавить RBAC/ABAC поддержку
  - _Требования: NFR-3.2, FR-8.3_

- [ ] 14. Создание Shard Manager
  - Реализовать логику разбиения данных на шарды
  - Добавить отслеживание владения шардами между зонами
  - Создать операции для миграции шардов
  - _Требования: FR-3.1, FR-3.2_

- [ ] 15. Реализация Health и SLI агрегации
  - Создать сбор метрик здоровья от кластеров
  - Реализовать агрегацию SLI (latency, error rate, capacity)
  - Добавить реакцию на деградацию производительности
  - _Требования: FR-5.2, FR-5.3_

- [ ] 16. Создание Cost Model
  - Реализовать модель стоимости для storage, egress, межзонного трафика
  - Добавить поддержку бюджетных ограничений
  - Создать алерты при превышении лимитов
  - _Требования: FR-6.1, FR-6.2_

- [ ] 17. Интеграция с IPNI Discovery
  - Реализовать проверку провайдеров через IPNI
  - Добавить публикацию информации о провайдерах после успешных пинов
  - Создать валидацию доступности контента
  - _Требования: FR-7.1, FR-7.2_

- [ ] 18. Реализация операций Pin/Unpin
  - Создать полный flow для pin операций с RF=4 через зоны MSK+NN
  - Интегрировать все компоненты: Policy → Scheduler → Orchestrator → Clusters
  - Добавить поддержку различных параметров (EC, tiering, placement hints)
  - Написать end-to-end тесты для pin операций
  - _Требования: FR-1.1, FR-1.2, NFR-1.2_

- [ ] 19. Создание операций ребалансировки
  - Реализовать алгоритмы для обнаружения дисбаланса
  - Добавить пошаговый ребаланс с backpressure
  - Создать операции draining и evacuation узлов
  - _Требования: FR-3.2, FR-3.3_

- [ ] 20. Реализация Policy симуляций
  - Создать what-if анализ для изменений политик
  - Добавить оценку влияния на стоимость и производительность
  - Реализовать предварительную валидацию политик
  - _Требования: FR-2.3_

- [ ] 21. Создание Admin UI (базовая версия)
  - Реализовать веб-интерфейс для управления политиками
  - Добавить мониторинг статуса зон и кластеров
  - Создать дашборды с основными метриками
  - _Требования: FR-8.1_

- [ ] 22. Реализация мульти-тенантности
  - Добавить поддержку namespaces и tenant isolation
  - Реализовать quota management на уровне тенантов
  - Создать tenant-aware политики и метрики
  - _Требования: FR-8.3_

- [ ] 23. Создание системы алертов и мониторинга
  - Настроить Prometheus метрики для всех компонентов
  - Создать Grafana дашборды для SLI/SLO мониторинга
  - Реализовать алерты для критических событий
  - _Требования: NFR-4.2_

- [ ] 24. Реализация аудита и логирования
  - Создать audit trail для всех операций
  - Добавить корреляцию событий через trace_id
  - Реализовать экспорт аудит-логов
  - _Требования: NFR-3.3, NFR-4.3_

- [ ] 25. Создание системы backup и disaster recovery
  - Реализовать backup метаданных из YDB
  - Добавить процедуры восстановления после сбоев
  - Создать runbooks для операционных процедур
  - _Требования: NFR-2.1, NFR-5.3_

- [ ] 26. Оптимизация производительности
  - Провести load testing для достижения ≥10k pin-ops/min
  - Оптимизировать критические пути в коде
  - Добавить кэширование для часто запрашиваемых данных
  - _Требования: NFR-1.1, NFR-1.2_

- [ ] 27. Реализация feature flags и канареечных развёртываний
  - Добавить систему feature flags для безопасного rollout
  - Создать поддержку канареечных развёртываний
  - Реализовать автоматический rollback при проблемах
  - _Требования: NFR-5.1_

- [ ] 28. Создание comprehensive тестов
  - Написать chaos engineering тесты для проверки отказоустойчивости
  - Добавить performance тесты для всех критических операций
  - Создать end-to-end тесты для полных пользовательских сценариев
  - _Требования: NFR-2.1, NFR-2.2_

- [ ] 29. Документация и SDK
  - Создать API документацию и примеры использования
  - Реализовать Go и TypeScript SDK для интеграции
  - Написать операционные руководства и troubleshooting guides
  - _Требования: FR-8.2_

- [ ] 30. Подготовка к production развёртыванию
  - Создать Kubernetes манифесты для развёртывания
  - Настроить CI/CD pipeline с автоматическими тестами
  - Провести security audit и penetration testing
  - Создать мониторинг готовности к production
  - _Требования: NFR-2.1, NFR-3.1, NFR-3.2_